from vstools import core, replace_ranges, finalize_clip
from vskernels import Hermite
from vsmuxtools import src_file, Setup, x265, settings_builder_x265, TmdbConfig, mux
from vspreview import set_output


imax_ranges = [(745, 1041), (1066, 2930), (4927, 4964), (5037, 5150), (5255, 5637), (7434, 8799), (10634, 13085), (14295, 14372), (16398, 17027), (20133, 20262), (21820, 22020), (22392, 22462), (23868, 24431), (26754, 26805), (26842, 26872), (27011, 27067), (27088, 27122), (27337, 27356), (27704, 27868), (31314, 31400), (31469, 31512), (35640, 36755), (38165, 38242), (38452, 38501), (40177, 40204), (41407, 41427), (41455, 41484), (42772, 43552), (46815, 46836), (46872, 46898), (48136, 48344), (54814, 54919), (55777, 55802), (55836, 55857), (56207, 56351), (56462, 56493), (57191, 57930), (58045, 58123), (59234, 59449), (60753, 61059), (61658, 61720), (67697, 67719), (67841, 68399), (68495, 68589), (68962, 68990), (71930, 72593), (74930, 75689), (77415, 78166), (78716, 78735), (78816, 78826), (78881, 78906), (78974, 79004), (79153, 79190), (81988, 82011), (84126, 84209), (85109, 85163), (85265, 85313), (86232, 86915), (87424, 87744), (87902, 87963), (88033, 88165), (89983, 90002), (90018, 90054), (91059, 91428), (92386, 92419), (92694, 92714), (92833, 92846), (92874, 92896), (93350, 93491), (96981, 97249), (101967, 102580), (106528, 107038), (107078, 107239), (107310, 107451), (110843, 110856), (110892, 110908), (110954, 110980), (112165, 112212), (113592, 113644), (113800, 113845), (121183, 121296), (125251, 125549), (125754, 125768), (125830, 125871), (125949, 126017), (126113, 126196), (126281, 126421), (131495, 131615), (133956, 134074), (134095, 134123), (134219, 134261), (134286, 134347), (135203, 135251), (135353, 135400), (136001, 136325), (138270, 138332), (138790, 140431), (140876, 141458), (148338, 149449), (149530, 149586), (149699, 150084), (150304, 150962), (151239, 151514), (151661, 152219), (152469, 155402), (155854, 155911), (157278, 158180), (160150, 161356), (162521, 163246), (163524, 172443), (173211, 173372), (173410, 173494), (173556, 173619), (174890, 175036), (175192, 175305), (175575, 175609), (176371, 176451), (177928, 178355), (179039, 179363), (180041, 186386), (190433, 191086), (191145, 191433), (191506, 191568), (192064, 192123), (192188, 192251), (192285, 192362), (194030, 194111), (194496, 194535), (194559, 194597), (194624, 194726), (194889, 194962), (195073, 195832), (199620, 200253), (204173, 204360), (204484, 204536), (204668, 205019), (205126, 205158), (205195, 205237), (205383, 205454), (205487, 205528), (205549, 205595), (206889, 208267), (209729, 209766), (209789, 209804), (209850, 209870), (221929, 221954), (233628, 233715), (233773, 233876), (246423, 246507), (247657, 247810), (247853, 250496)]

core

setup = Setup("00")

WEBDL = src_file(r"D:\data\torrents\Oppenheimer (2023) (2160p MA WEB-DL H265 SDR DDP 5.1 English - HONE).mkv")
webdl = WEBDL.init_cut()
ds4k_webdl = Hermite.descale(webdl, 1920, 1080, linear=True)
ds4k_src = ds4k_webdl[24:]

BD = src_file(r"D:\data\torrents\Oppenheimer.2023.BluRay.1080p.DTS-HD.MA.5.1.AVC.REMUX-FraMeSToR.mkv")
bd = BD.init_cut()

pre_final = replace_ranges(ds4k_src, bd, imax_ranges)
final = finalize_clip(pre_final, 10)

if __name__ == "__main__":
    settings = settings_builder_x265(
        crf=19,
        aq_strength=0.75, psy_rd=2.0, psy_rdoq=1,
        qcomp=0.7, rd=4,
        preset="veryslow",
        deblock=[-3, -3], ref=5, bframes=12,
        aq_mode=3,
        rect=False
    )
    enc = x265(settings).encode(final)
    mux(
        enc.to_track(name="Encoded by AnoZu", lang="en"),
        tmdb=TmdbConfig(872585, movie=True, language="en-US", write_date=False, write_cover=True),
    )
else:
    set_output(final)