from vstools import core, replace_ranges, finalize_clip
from vskernels import Hermite
from vsmuxtools import src_file, Setup, x265, settings_builder_x265, do_audio, SubFile, TmdbConfig, mux
from vspreview import set_output


imax_ranges = [(745, 1041), (1066, 2930), (4927, 4964), (5037, 5150), (5255, 5637), (7434, 8799), (10634, 13085), (14295, 14372), (16398, 17027), (20133, 20262), (21820, 22020), (22392, 22462), (23868, 24431), (26754, 26805), (26842, 26872), (27011, 27067), (27088, 27122), (27337, 27356), (27704, 27868), (31314, 31400), (31469, 31512), (35640, 36755), (38165, 38242), (38452, 38501), (40177, 40204), (41407, 41427), (41455, 41484), (42772, 43552), (46815, 46836), (46872, 46898), (48136, 48344), (54814, 54919), (55777, 55802), (55836, 55857), (56207, 56351), (56462, 56493), (57191, 57930), (58045, 58123), (59234, 59449), (60753, 61059), (61658, 61720), (67697, 67719), (67841, 68399), (68495, 68589), (68962, 68990), (71930, 72593), (74930, 75689), (77415, 78166), (78716, 78735), (78816, 78826), (78881, 78906), (78974, 79004), (79153, 79190), (81988, 82011), (84126, 84209), (85109, 85163), (85265, 85313), (86232, 86915), (87424, 87744), (87902, 87963), (88033, 88165), (89983, 90002), (90018, 90054), (91059, 91428), (92386, 92419), (92694, 92714), (92833, 92846), (92874, 92896), (93350, 93491), (96981, 97249), (101967, 102580), (106528, 107038), (107078, 107239), (107310, 107451), (110843, 110856), (110892, 110908), (110954, 110980), (112165, 112212), (113592, 113644), (113800, 113845), (121183, 121296), (125251, 125549), (125754, 125768), (125830, 125871), (125949, 126017), (126113, 126196), (126281, 126421), (131495, 131615), (133956, 134074), (134095, 134123), (134219, 134261), (134286, 134347), (135203, 135251), (135353, 135400), (136001, 136325), (138270, 138332), (138790, 140431), (140876, 141458), (148338, 149449), (149530, 149586), (149699, 150084), (150304, 150962), (151239, 151514), (151661, 152219), (152469, 155402), (155854, 155911), (157278, 158180), (160150, 161356), (162521, 163246), (163524, 172443), (173211, 173372), (173410, 173494), (173556, 173619), (174890, 175036), (175192, 175305), (175575, 175609), (176371, 176451), (177928, 178355), (179039, 179363), (180041, 186386), (190433, 191086), (191145, 191433), (191506, 191568), (192064, 192123), (192188, 192251), (192285, 192362), (194030, 194111), (194496, 194535), (194559, 194597), (194624, 194726), (194889, 194962), (195073, 195832), (199620, 200253), (204173, 204360), (204484, 204536), (204668, 205019), (205126, 205158), (205195, 205237), (205383, 205454), (205487, 205528), (205549, 205595), (206889, 208267), (209729, 209766), (209789, 209804), (209850, 209870), (221929, 221954), (233628, 233715), (233773, 233876), (246423, 246507), (247657, 247810), (247853, 250496)]

core

setup = Setup("01")

WEBDL = src_file(r"D:\data\media\movies\Oppenheimer (2023) [tmdbid-872585]\Oppenheimer (2023) (2160p MA WEB-DL H265 SDR DDP 5.1 English - HONE).mkv")
webdl = WEBDL.init_cut()
ds4k_webdl = Hermite.descale(webdl, 1920, 1080, linear=True)
ds4k_src = ds4k_webdl[24:]

BD = src_file(r"D:\data\torrents\Oppenheimer.2023.BluRay.1080p.DTS-HD.MA.5.1.AVC.REMUX-FraMeSToR.mkv")
bd = BD.init_cut()

pre_final = replace_ranges(ds4k_src, bd, imax_ranges)
final = finalize_clip(pre_final, 10)

#test = src_file(r"C:\Users\Hammad Ansari\Desktop\Encoding-Scripts\Oppenheimer (2023)\_workdir\01\encoded_part_000.265")
#test2 = test.init()
if __name__ == "__main__":
    settings = settings_builder_x265(
        crf=19,
        aq_strength=0.75, psy_rd=2.0, psy_rdoq=1,
        qcomp=0.7, rd=4,
        preset="veryslow",
        deblock=[-3, -3], ref=5, bframes=12,
        aq_mode=3,
        rect=False
    )
    #zones = [(745, 1041, 1), (1066, 2930, 1), (4927, 4964, 1), (5037, 5150, 1), (5255, 5637, 1), (7434, 8799, 2), (10634, 13085, 2), (14295, 14372, 2), (16398, 17027, 2), (20133, 20262, 2), (21820, 22020, 2), (22392, 22462, 2), (23868, 24431, 2), (26754, 26805, 2), (26842, 26872, 2), (27011, 27067, 2), (27088, 27122, 2), (27337, 27356, 2), (27704, 27868, 2), (31314, 31400, 2), (31469, 31512, 2), (35640, 36755, 2), (38165, 38242, 2), (38452, 38501, 2), (40177, 40204, 2), (41407, 41427, 2), (41455, 41484, 2), (42772, 43552, 2), (46815, 46836, 2), (46872, 46898, 2), (48136, 48344, 2), (54814, 54919, 2), (55777, 55802, 2), (55836, 55857, 2), (56207, 56351, 2), (56462, 56493, 2), (57191, 57930, 2), (58045, 58123, 2), (59234, 59449, 2), (60753, 61059, 2), (61658, 61720, 2), (67697, 67719, 2), (67841, 68399, 2), (68495, 68589, 2), (68962, 68990, 2), (71930, 72593, 2), (74930, 75689, 2), (77415, 78166, 2), (78716, 78735, 2), (78816, 78826, 2), (78881, 78906, 2), (78974, 79004, 2), (79153, 79190, 2), (81988, 82011, 2), (84126, 84209, 2), (85109, 85163, 2), (85265, 85313, 2), (86232, 86915, 2), (87424, 87744, 2), (87902, 87963, 2), (88033, 88165, 2), (89983, 90002, 2), (90018, 90054, 2), (91059, 91428, 2), (92386, 92419, 2), (92694, 92714, 2), (92833, 92846, 2), (92874, 92896, 2), (93350, 93491, 2), (96981, 97249, 2), (101967, 102580, 2), (106528, 107038, 2), (107078, 107239, 2), (107310, 107451, 2), (110843, 110856, 2), (110892, 110908, 2), (110954, 110980, 2), (112165, 112212, 2), (113592, 113644, 2), (113800, 113845, 2), (121183, 121296, 2), (125251, 125549, 2), (125754, 125768, 2), (125830, 125871, 2), (125949, 126017, 2), (126113, 126196, 2), (126281, 126421, 2), (131495, 131615, 2), (133956, 134074, 2), (134095, 134123, 2), (134219, 134261, 2), (134286, 134347, 2), (135203, 135251, 2), (135353, 135400, 2), (136001, 136325, 2), (138270, 138332, 2), (138790, 140431, 2), (140876, 141458, 2), (148338, 149449, 2), (149530, 149586, 2), (149699, 150084, 2), (150304, 150962, 2), (151239, 151514, 2), (151661, 152219,2), (152469, 155402, 2), (155854, 155911, 2), (157278, 158180, 2), (160150, 161356, 2), (162521, 163246, 2), (163524, 172443, 2), (173211, 173372, 2), (173410, 173494, 2), (173556, 173619, 2), (174890, 175036, 2), (175192, 175305, 2), (175575, 175609, 2), (176371, 176451, 2), (177928, 178355, 2), (179039, 179363, 2), (180041, 186386, 2), (190433, 191086, 2), (191145, 191433, 2), (191506, 191568, 2), (192064, 192123, 2), (192188, 192251, 2), (192285, 192362, 2), (194030, 194111, 2), (194496, 194535, 2), (194559, 194597, 2), (194624, 194726, 2), (194889, 194962, 2), (195073, 195832, 2), (199620, 200253, 2), (204173, 204360, 2), (204484, 204536, 2), (204668, 205019, 2), (205126, 205158, 2), (205195, 205237, 2), (205383, 205454, 2), (205487, 205528, 2), (205549, 205595, 2), (206889, 208267, 2), (209729, 209766, 2), (209789, 209804, 2), (209850, 209870, 2), (221929, 221954, 2), (233628, 233715, 2), (233773, 233876, 2), (246423, 246507, 2), (247657, 247810, 2), (247853, 250496, 2)]
    enc = x265(settings).encode(final)
    #audio = do_audio(ds4k_src, 0)
    mux(
        enc.to_track(name="Encoded by AnoZu", lang="en"),
        tmdb=TmdbConfig(872585, movie=True, language="en-US", write_date=False, write_cover=True),
    )
else:
    set_output(final)

#set_output(ds4k_src)
#set_output(bd)
#set_output(core.lsmas.LWLibavSource(r"C:\Users\Hammad Ansari\Desktop\raw\ep02.hevc"))
#set_output(core.lsmas.LWLibavSource(r"C:\Users\Hammad Ansari\Desktop\raw\ep00.hevc"))
#set_output(test2)